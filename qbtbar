#!/bin/bash

echo -e "qBittorrent Backup And Restore (QBTBAR) v1.0\n(c) 2024, Alex Free (3-BSD)\n"

is_running()
{
	if pgrep -x qbittorrent >/dev/null; then
		echo "Error: qBittorrent is currently running, and must be closed to continue. Please pause all torrents and exit qBittorrent before running qbtbar."
		exit 1
	fi
}

is_installed()
{
	if ! command -v qbittorrent &> /dev/null; then
		echo "Info: qBittorrent is not installed."
		
		if command -v apt &> /dev/null; then
			echo "Info: APT package manager detected. Root privileges are required to installed qBittorrent:"
			sudo apt update
			sudo apt install -y qbittorrent
		elif command -v dnf &> /dev/null; then
			echo "Info: DNF package manager detected. Root privileges are required to installed qBittorrent:"
			sudo dnf update
			sudo dnf install -y qbittorrent
		else
			echo "Error: Unknown package manager. qBittorrent can not be installed automatically. Please install qBittorrent before using qtbar"
			exit 1
		fi
	else
		echo "Found qBittorrent."
	fi
}

backup_qbt() 
{
	if ! [ -d "$HOME/.local/share/qBittorrent" ]; then
		echo "Error: \""$HOME/.local/share/qBitorrent"\" doesn't exist, so nothing can be backed up."
		exit 1
	fi

	if ! [ -d "$HOME/.local/share/qBittorrent/BT_backup" ]; then
		echo "Error: \"$HOME/.local/share/qBittorrent\" does not contain a \"BT_backup\" directory, so nothing can be backed up."
		exit 1
	fi

	if ! [ -d "$2" ]; then
		mkdir -p "$1"
		echo "Info: the target parent directory \""$1\"" did not exist, so it was created."
		exit 1
	fi

	target=$(date +%m-%d-%y-\(%H:%M:%S\))
	target="qBittorrent_$target"

	if [ -d "$2"/"$target" ]; then
		echo "Error: the target directory \""$target"\" already exists and will not be modified."
		exit 1
	fi

	is_running

	cp -r ~/.local/share/qBittorrent "$2"/"$target"
	echo "Backup created at \"""$2"/"$target"\".
}

restore_qbt() 
{
	if ! [ -d "$2" ]; then
		echo "Error: \""$2"\" is not a directory."
		exit 1
	fi

	if ! [ -d "$2/BT_backup" ]; then
		echo "Error: $2 doesn't contain a \""BT_backup"\" directory."
		exit 1
	fi

	if ! [ -d "$HOME/.local/share/qBittorrent" ]; then
		mkdir -p ~/.local/share/qBittorrent
		echo "Info: \""$HOME/.local/share/qBitorrent"\" doesn't already exist, so it has been created."
	fi

	is_running

	cp -r "$2" ~/.local/share/Qbitorrent
	echo "Backup restored from \"""$2"\".
}

display_usage() 
{
    echo -e "\nUsage: qbtbar <mode> <directory>\n\n<mode>:\n-b\tCreate a backup.\n-r\tRestore a backup.\n\n<directory>\tFor backup mode, this specifies the parent directory to generate the backup into (the backup directory name itself is auto-generated). For restore mode this specifies a backup directory previously generated by backup mode.\n" 

	exit 1
}

if [ $# -ne 2 ]; then
	echo "Error: Incorrect number of arguments."
	display_usage
fi

if [ "$1" == "-b" ]; then
	backup_qbt "$1" "$2"
elif [ "$1" == "-r" ]; then
	restore_qbt "$1" "$2"
else
	echo "Error: First argument must be -r or -b."
	display_usage
fi

